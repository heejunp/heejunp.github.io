---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import BlogHeader from '../../components/BlogHeader.astro';
import CategorySidebar from '../../components/CategorySidebar.astro';
import TagCloud from '../../components/TagCloud.astro';
import BackButton from '../../components/BackButton.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const allPosts = await getCollection('blog');

// 필터링 로직
function filterPosts(posts: typeof allPosts, category?: string | null, tags: string[] = []) {
	let filtered = posts;
	
	if (category) {
		filtered = filtered.filter((post) => post.data.category === category);
	}
	
	if (tags.length > 0) {
		filtered = filtered.filter((post) => {
			const postTags = post.data.tags || [];
			return tags.every(tag => postTags.includes(tag));
		});
	}
	
	return filtered.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
}

// 카테고리 및 태그 필터링 (여러 태그 지원)
const categoryFilter = Astro.url.searchParams.get('category');
const tagFilters = Astro.url.searchParams.getAll('tag');
const posts = filterPosts(allPosts, categoryFilter, tagFilters);

// 필터 표시 여부
const hasActiveFilters = !!(categoryFilter || tagFilters.length > 0);
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION} includeSidebar={false}>
	<div class="blog-page-wrapper">
		<BlogHeader />
		<div class="blog-content-wrapper">
			<aside class="category-sidebar-wrapper">
				<CategorySidebar />
			</aside>
			<section class="blog-section">
				{hasActiveFilters && (
					<div class="category-filter-info">
						<h2 class="filter-title">
							{categoryFilter && `Category: ${categoryFilter}`}
							{categoryFilter && tagFilters.length > 0 && ' | '}
							{tagFilters.length > 0 && `Tags: ${tagFilters.join(', ')}`}
						</h2>
						<a href="/blog" class="clear-filter">Clear Filter</a>
					</div>
				)}
				<ul class="blog-list">
					{
						posts.map((post) => (
							<li class="blog-card" data-tags={post.data.tags?.join(',') || ''} data-category={post.data.category || ''}>
								<a href={`/blog/${post.id}/`} class="blog-link">
									{post.data.heroImage && (
										<div class="blog-image-wrapper">
											<Image width={720} height={360} src={post.data.heroImage} alt="" class="blog-image" />
										</div>
									)}
									<div class="blog-content">
										<h4 class="blog-title-text">{post.data.title}</h4>
										<p class="blog-date">
											<FormattedDate date={post.data.pubDate} />
										</p>
									</div>
								</a>
							</li>
						))
					}
				</ul>
				<BackButton />
			</section>
			<aside class="tag-cloud-wrapper">
				<TagCloud />
			</aside>
		</div>
	</div>
</BaseLayout>

<style>
	/* CSS 변수는 global.css에서 전역으로 정의됨 */

	.blog-page-wrapper {
		width: 100%;
		min-height: 100vh;
		background: var(--color-bg-dark);
		display: flex;
		flex-direction: column;
	}

	.blog-content-wrapper {
		flex: 1;
		width: 100%;
		position: relative;
		display: grid;
		grid-template-columns: var(--sidebar-width) 1fr var(--sidebar-width);
		gap: var(--spacing-lg);
		padding: var(--spacing-lg);
		max-width: var(--max-content-width);
		margin: 0 auto;
	}

	/* 공통 스크롤바 스타일 */
	:global(.custom-scrollbar) {
		scrollbar-width: thin;
		scrollbar-color: var(--color-primary) var(--color-nebula-green);
	}

	:global(.custom-scrollbar)::-webkit-scrollbar {
		width: 6px;
	}

	:global(.custom-scrollbar)::-webkit-scrollbar-track {
		background: var(--color-nebula-green);
	}

	:global(.custom-scrollbar)::-webkit-scrollbar-thumb {
		background: var(--color-primary);
		border-radius: 3px;
	}

	.category-sidebar-wrapper {
		position: sticky;
		top: calc(var(--header-height) + var(--spacing-lg));
		align-self: start;
		height: fit-content;
		max-height: calc(100vh - 100px);
		overflow-y: auto;
		overflow-x: hidden;
		z-index: 10;
	}

	.category-sidebar-wrapper :global(.category-sidebar) {
		max-height: calc(100vh - 100px);
		overflow-y: auto;
		overflow-x: hidden;
	}

	.tag-cloud-wrapper {
		position: sticky;
		top: calc(var(--header-height) + var(--spacing-lg));
		align-self: start;
		height: fit-content;
		max-height: calc(100vh - 100px);
		overflow: visible;
		z-index: 100;
		pointer-events: auto;
	}

	.tag-cloud-wrapper :global(.tag-cloud) {
		max-height: calc(100vh - 100px);
		overflow-y: auto;
		overflow-x: hidden;
		pointer-events: auto;
		position: relative;
		z-index: 100;
	}

	.tag-cloud-wrapper :global(.tag-cloud-item) {
		position: relative;
		z-index: 101;
		pointer-events: auto !important;
	}

	.blog-section {
		min-height: calc(100vh - var(--header-height));
		padding: 0;
		background: transparent;
		position: relative;
		overflow: visible;
		width: 100%;
		max-width: 100%;
		z-index: 1;
	}

	/* 우주 배경 - 별들 */
	.blog-section::before {
		content: '';
		position: absolute;
		inset: 0;
		background-image: 
			radial-gradient(3px 3px at 10% 20%, #ffffff, transparent),
			radial-gradient(2px 2px at 20% 30%, #ffffff, transparent),
			radial-gradient(1px 1px at 30% 15%, #ffffff, transparent),
			radial-gradient(2px 2px at 40% 25%, #ffffff, transparent),
			radial-gradient(1px 1px at 50% 10%, #ffffff, transparent),
			radial-gradient(3px 3px at 60% 20%, #ffffff, transparent),
			radial-gradient(2px 2px at 70% 30%, #ffffff, transparent),
			radial-gradient(1px 1px at 80% 15%, #ffffff, transparent),
			radial-gradient(2px 2px at 90% 25%, #ffffff, transparent),
			radial-gradient(1px 1px at 15% 40%, #ffffff, transparent),
			radial-gradient(2px 2px at 25% 50%, #ffffff, transparent),
			radial-gradient(1px 1px at 35% 45%, #ffffff, transparent),
			radial-gradient(3px 3px at 45% 55%, #ffffff, transparent),
			radial-gradient(2px 2px at 55% 40%, #ffffff, transparent),
			radial-gradient(1px 1px at 65% 50%, #ffffff, transparent),
			radial-gradient(2px 2px at 75% 60%, #ffffff, transparent),
			radial-gradient(1px 1px at 85% 45%, #ffffff, transparent),
			radial-gradient(3px 3px at 95% 55%, #ffffff, transparent),
			radial-gradient(2px 2px at 5% 70%, #ffffff, transparent),
			radial-gradient(1px 1px at 15% 80%, #ffffff, transparent),
			radial-gradient(2px 2px at 25% 75%, #ffffff, transparent),
			radial-gradient(1px 1px at 35% 85%, #ffffff, transparent),
			radial-gradient(3px 3px at 45% 70%, #ffffff, transparent),
			radial-gradient(2px 2px at 55% 80%, #ffffff, transparent),
			radial-gradient(1px 1px at 65% 75%, #ffffff, transparent),
			radial-gradient(2px 2px at 75% 85%, #ffffff, transparent),
			radial-gradient(1px 1px at 85% 90%, #ffffff, transparent),
			radial-gradient(3px 3px at 95% 95%, #ffffff, transparent),
			radial-gradient(2px 2px at 12% 60%, #ffffff, transparent),
			radial-gradient(1px 1px at 22% 65%, #ffffff, transparent),
			radial-gradient(2px 2px at 32% 70%, #ffffff, transparent),
			radial-gradient(1px 1px at 42% 65%, #ffffff, transparent),
			radial-gradient(3px 3px at 52% 60%, #ffffff, transparent),
			radial-gradient(2px 2px at 62% 65%, #ffffff, transparent),
			radial-gradient(1px 1px at 72% 70%, #ffffff, transparent),
			radial-gradient(2px 2px at 82% 65%, #ffffff, transparent),
			radial-gradient(1px 1px at 92% 60%, #ffffff, transparent);
		background-size: 200% 200%;
		background-position: 0% 0%;
		opacity: 1;
		pointer-events: none;
		animation: starMove 50s linear infinite;
		z-index: 0;
	}

	/* 우주 배경 - 네뷸라 */
	.blog-section::after {
		content: '';
		position: absolute;
		inset: 0;
		background: 
			radial-gradient(ellipse at 20% 30%, var(--color-nebula-green) 0%, transparent 50%),
			radial-gradient(ellipse at 80% 70%, var(--color-nebula-gold) 0%, transparent 50%),
			radial-gradient(ellipse at 50% 50%, var(--color-nebula-pink) 0%, transparent 50%),
			radial-gradient(ellipse at 30% 80%, var(--color-nebula-cyan) 0%, transparent 50%);
		pointer-events: none;
		z-index: 0;
		animation: nebulaPulse 20s ease-in-out infinite alternate;
	}

	@keyframes starMove {
		0% { 
			background-position: 0% 0%;
		}
		100% { 
			background-position: 100% 100%;
		}
	}

	@keyframes nebulaPulse {
		0% {
			opacity: 0.5;
			transform: scale(1);
		}
		100% {
			opacity: 1;
			transform: scale(1.1);
		}
	}

	.category-filter-info {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: var(--spacing-lg);
		padding: var(--spacing-sm) var(--spacing-md);
		background: var(--color-bg-card);
		border: var(--border-width) solid var(--color-primary);
		box-shadow: var(--shadow-offset) var(--shadow-offset) 0 0 var(--color-primary);
		position: relative;
		z-index: 1;
	}

	.filter-title {
		font-family: 'Pretendard', 'Courier New', monospace;
		font-size: 1.5rem;
		font-weight: 700;
		color: var(--color-primary);
		margin: 0;
		text-shadow: 2px 2px 0 var(--color-shadow-dark);
		letter-spacing: 0.1em;
	}

	.clear-filter {
		padding: var(--spacing-xs) var(--spacing-sm);
		background: var(--color-nebula-green);
		border: 2px solid var(--color-primary);
		color: var(--color-primary);
		text-decoration: none;
		font-family: 'Pretendard', 'Courier New', monospace;
		font-weight: 700;
		font-size: 0.9rem;
		transition: all 0.2s ease;
		box-shadow: 2px 2px 0 0 var(--color-primary);
	}

	.clear-filter:hover {
		background: rgba(0, 255, 65, 0.2);
		transform: translate(-1px, -1px);
		box-shadow: 3px 3px 0 0 var(--color-primary);
		color: var(--color-secondary);
		border-color: var(--color-secondary);
	}

	.blog-title {
		font-family: 'Courier New', monospace;
		font-size: clamp(2.5rem, 5vw, 4rem);
		font-weight: 700;
		color: var(--color-primary);
		text-align: center;
		margin: 0 0 var(--spacing-xl) 0;
		text-shadow: 
			4px 4px 0 var(--color-shadow-dark),
			8px 8px 0 var(--color-shadow-darker);
		letter-spacing: 0.1em;
		position: relative;
		z-index: 1;
	}

	.blog-list {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
		gap: var(--spacing-lg);
		list-style-type: none;
		margin: 0 auto;
		padding: 0;
		max-width: var(--max-blog-width);
		position: relative;
		z-index: 1;
	}

	.blog-card {
		width: 100%;
	}

	.blog-link {
		display: block;
		text-decoration: none;
		background: var(--color-bg-card);
		border: var(--border-width) solid var(--color-primary);
		padding: 0;
		transition: all 0.2s ease;
		box-shadow: var(--shadow-offset) var(--shadow-offset) 0 0 var(--color-primary);
		overflow: hidden;
	}

	.blog-link:hover {
		transform: translate(-2px, -2px);
		box-shadow: 6px 6px 0 0 var(--color-accent);
		border-color: var(--color-accent);
	}

	.blog-image-wrapper {
		width: 100%;
		overflow: hidden;
		background: var(--color-bg-image);
	}

	.blog-image {
		width: 100%;
		height: auto;
		display: block;
		transition: transform 0.3s ease;
		image-rendering: pixelated;
	}

	.blog-link:hover .blog-image {
		transform: scale(1.05);
	}

	.blog-content {
		padding: var(--spacing-md);
	}

	.blog-title-text {
		font-family: 'Courier New', monospace;
		font-size: clamp(1.2rem, 2vw, 1.5rem);
		font-weight: 700;
		margin: 0 0 0.75rem 0;
		color: var(--color-primary);
		line-height: 1.3;
		text-shadow: 2px 2px 0 var(--color-shadow-dark);
		transition: color 0.2s ease;
	}

	.blog-link:hover .blog-title-text {
		color: var(--color-accent);
	}

	.blog-date {
		font-family: 'Courier New', monospace;
		font-size: 0.9rem;
		margin: 0;
		color: var(--color-accent);
		text-shadow: 1px 1px 0 var(--color-shadow-dark);
	}

	@media (max-width: 1279px) {
		.blog-content-wrapper {
			grid-template-columns: 1fr;
			padding: var(--spacing-sm);
			gap: var(--spacing-sm);
		}

		.category-sidebar-wrapper,
		.tag-cloud-wrapper {
			display: none;
		}
	}

	@media (max-width: 768px) {
		.blog-content-wrapper {
			padding: var(--spacing-sm);
		}

		.blog-list {
			grid-template-columns: 1fr;
			gap: var(--spacing-md);
		}

		.blog-title {
			margin-bottom: var(--spacing-lg);
			font-size: clamp(2rem, 6vw, 3rem);
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const clearFilterLink = document.querySelector<HTMLAnchorElement>('.clear-filter');
		const blogCards = document.querySelectorAll<HTMLElement>('.blog-card');
		const categoryFilterInfo = document.querySelector<HTMLElement>('.category-filter-info');
		const filterTitle = document.querySelector<HTMLElement>('.filter-title');
		const categoryLinks = document.querySelectorAll<HTMLElement>('.category-item a');
		const tagLinks = document.querySelectorAll<HTMLElement>('.tag-cloud-item');
		
		function clearAllFilters() {
			window.history.pushState({}, '', '/blog');
			
			blogCards.forEach((card) => {
				card.style.display = '';
			});
			
			if (categoryFilterInfo) {
				categoryFilterInfo.style.display = 'none';
			}
			if (filterTitle) {
				filterTitle.textContent = '';
			}
			
			categoryLinks.forEach((link) => {
				link.classList.remove('active');
			});
			
			tagLinks.forEach((link) => {
				if (link.classList.contains('all-tag')) {
					link.classList.add('active');
				} else {
					link.classList.remove('active');
				}
			});
			
			window.dispatchEvent(new CustomEvent('clearAllFilters'));
		}
		
		clearFilterLink?.addEventListener('click', (e) => {
			e.preventDefault();
			clearAllFilters();
		});
		
		window.addEventListener('clearAllFilters', clearAllFilters);
	});
</script>