---
import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import BlogHeader from '../../components/BlogHeader.astro';
import CategorySidebar from '../../components/CategorySidebar.astro';
import TagCloud from '../../components/TagCloud.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const allPosts = await getCollection('blog');

// 카테고리 및 태그 필터링 (여러 태그 지원)
const categoryFilter = Astro.url.searchParams.get('category');
const tagFilters = Astro.url.searchParams.getAll('tag');

let filteredPosts = allPosts;

// 카테고리 필터링
if (categoryFilter) {
	filteredPosts = filteredPosts.filter((post) => {
		return post.data.category === categoryFilter;
	});
}

// 태그 필터링 (여러 태그 지원)
if (tagFilters.length > 0) {
	filteredPosts = filteredPosts.filter((post) => {
		const tags = post.data.tags || [];
		// 선택된 모든 태그를 가진 글만 표시
		return tagFilters.every(tagFilter => tags.includes(tagFilter));
	});
}

const posts = filteredPosts.sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION} includeSidebar={false}>
	<div class="blog-page-wrapper">
		<BlogHeader />
		<div class="blog-content-wrapper">
			<aside class="category-sidebar-wrapper">
				<CategorySidebar />
			</aside>
			<section class="blog-section">
				<div class="category-filter-info" style="display: {(categoryFilter || tagFilters.length > 0) ? 'flex' : 'none'};">
					<h2 class="filter-title">
						{categoryFilter && `Category: ${categoryFilter}`}
						{categoryFilter && tagFilters.length > 0 && ' | '}
						{tagFilters.length > 0 && `Tags: ${tagFilters.join(', ')}`}
					</h2>
					<a href="/blog" class="clear-filter">Clear Filter</a>
				</div>
				<ul class="blog-list">
					{
						posts.map((post) => (
							<li class="blog-card" data-tags={post.data.tags?.join(',') || ''} data-category={post.data.category || ''}>
								<a href={`/blog/${post.id}/`} class="blog-link">
									{post.data.heroImage && (
										<div class="blog-image-wrapper">
											<Image width={720} height={360} src={post.data.heroImage} alt="" class="blog-image" />
										</div>
									)}
									<div class="blog-content">
										<h4 class="blog-title-text">{post.data.title}</h4>
										<p class="blog-date">
											<FormattedDate date={post.data.pubDate} />
										</p>
									</div>
								</a>
							</li>
						))
					}
				</ul>
				<a href="/?skipIntro=true" class="back-button">
					<span class="back-arrow">←</span>
					<span class="back-text">뒤로</span>
				</a>
			</section>
			<aside class="tag-cloud-wrapper">
				<TagCloud />
			</aside>
		</div>
	</div>
</BaseLayout>

<style>
	.blog-page-wrapper {
		width: 100%;
		min-height: 100vh;
		background: #000000;
		display: flex;
		flex-direction: column;
	}

	.blog-content-wrapper {
		flex: 1;
		width: 100%;
		position: relative;
		display: grid;
		grid-template-columns: 250px 1fr 250px;
		gap: 2rem;
		padding: 2rem;
		max-width: 1800px;
		margin: 0 auto;
	}

	.category-sidebar-wrapper {
		position: sticky;
		top: calc(80px + 2rem);
		align-self: start;
		height: fit-content;
		max-height: calc(100vh - 100px);
		overflow-y: auto;
		overflow-x: hidden;
		z-index: 10;
	}

	.category-sidebar-wrapper :global(.category-sidebar) {
		max-height: calc(100vh - 100px);
		overflow-y: auto;
		overflow-x: hidden;
		scrollbar-width: thin;
		scrollbar-color: #00ff41 rgba(0, 255, 65, 0.1);
	}

	.category-sidebar-wrapper :global(.category-sidebar)::-webkit-scrollbar {
		width: 6px;
	}

	.category-sidebar-wrapper :global(.category-sidebar)::-webkit-scrollbar-track {
		background: rgba(0, 255, 65, 0.1);
	}

	.category-sidebar-wrapper :global(.category-sidebar)::-webkit-scrollbar-thumb {
		background: #00ff41;
		border-radius: 3px;
	}

	.tag-cloud-wrapper {
		position: sticky;
		top: calc(80px + 2rem);
		align-self: start;
		height: fit-content;
		max-height: calc(100vh - 100px);
		overflow: visible;
		z-index: 100;
		pointer-events: auto;
	}

	.tag-cloud-wrapper :global(.tag-cloud) {
		max-height: calc(100vh - 100px);
		overflow-y: auto;
		overflow-x: hidden;
		scrollbar-width: thin;
		scrollbar-color: #00ff41 rgba(0, 255, 65, 0.1);
		pointer-events: auto;
		position: relative;
		z-index: 100;
	}

	.tag-cloud-wrapper :global(.tag-cloud-item) {
		position: relative;
		z-index: 101;
		pointer-events: auto !important;
	}

	.tag-cloud-wrapper :global(.tag-cloud)::-webkit-scrollbar {
		width: 6px;
	}

	.tag-cloud-wrapper :global(.tag-cloud)::-webkit-scrollbar-track {
		background: rgba(0, 255, 65, 0.1);
	}

	.tag-cloud-wrapper :global(.tag-cloud)::-webkit-scrollbar-thumb {
		background: #00ff41;
		border-radius: 3px;
	}

	.blog-section {
		min-height: calc(100vh - 80px);
		padding: 0;
		background: transparent;
		position: relative;
		overflow: visible;
		width: 100%;
		max-width: 100%;
		z-index: 1;
	}

	/* 우주 배경 */
	.blog-section::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-image: 
			radial-gradient(3px 3px at 10% 20%, #ffffff, transparent),
			radial-gradient(2px 2px at 20% 30%, #ffffff, transparent),
			radial-gradient(1px 1px at 30% 15%, #ffffff, transparent),
			radial-gradient(2px 2px at 40% 25%, #ffffff, transparent),
			radial-gradient(1px 1px at 50% 10%, #ffffff, transparent),
			radial-gradient(3px 3px at 60% 20%, #ffffff, transparent),
			radial-gradient(2px 2px at 70% 30%, #ffffff, transparent),
			radial-gradient(1px 1px at 80% 15%, #ffffff, transparent),
			radial-gradient(2px 2px at 90% 25%, #ffffff, transparent),
			radial-gradient(1px 1px at 15% 40%, #ffffff, transparent),
			radial-gradient(2px 2px at 25% 50%, #ffffff, transparent),
			radial-gradient(1px 1px at 35% 45%, #ffffff, transparent),
			radial-gradient(3px 3px at 45% 55%, #ffffff, transparent),
			radial-gradient(2px 2px at 55% 40%, #ffffff, transparent),
			radial-gradient(1px 1px at 65% 50%, #ffffff, transparent),
			radial-gradient(2px 2px at 75% 60%, #ffffff, transparent),
			radial-gradient(1px 1px at 85% 45%, #ffffff, transparent),
			radial-gradient(3px 3px at 95% 55%, #ffffff, transparent),
			radial-gradient(2px 2px at 5% 70%, #ffffff, transparent),
			radial-gradient(1px 1px at 15% 80%, #ffffff, transparent),
			radial-gradient(2px 2px at 25% 75%, #ffffff, transparent),
			radial-gradient(1px 1px at 35% 85%, #ffffff, transparent),
			radial-gradient(3px 3px at 45% 70%, #ffffff, transparent),
			radial-gradient(2px 2px at 55% 80%, #ffffff, transparent),
			radial-gradient(1px 1px at 65% 75%, #ffffff, transparent),
			radial-gradient(2px 2px at 75% 85%, #ffffff, transparent),
			radial-gradient(1px 1px at 85% 90%, #ffffff, transparent),
			radial-gradient(3px 3px at 95% 95%, #ffffff, transparent),
			radial-gradient(2px 2px at 12% 60%, #ffffff, transparent),
			radial-gradient(1px 1px at 22% 65%, #ffffff, transparent),
			radial-gradient(2px 2px at 32% 70%, #ffffff, transparent),
			radial-gradient(1px 1px at 42% 65%, #ffffff, transparent),
			radial-gradient(3px 3px at 52% 60%, #ffffff, transparent),
			radial-gradient(2px 2px at 62% 65%, #ffffff, transparent),
			radial-gradient(1px 1px at 72% 70%, #ffffff, transparent),
			radial-gradient(2px 2px at 82% 65%, #ffffff, transparent),
			radial-gradient(1px 1px at 92% 60%, #ffffff, transparent);
		background-size: 200% 200%;
		background-position: 0% 0%;
		opacity: 1;
		pointer-events: none;
		animation: starMove 50s linear infinite;
		z-index: 0;
	}

	.blog-section::after {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: 
			radial-gradient(ellipse at 20% 30%, rgba(0, 255, 65, 0.1) 0%, transparent 50%),
			radial-gradient(ellipse at 80% 70%, rgba(255, 215, 0, 0.08) 0%, transparent 50%),
			radial-gradient(ellipse at 50% 50%, rgba(233, 69, 96, 0.06) 0%, transparent 50%);
		pointer-events: none;
		z-index: 0;
		animation: nebulaPulse 20s ease-in-out infinite alternate;
	}

	@keyframes starMove {
		0% { 
			background-position: 0% 0%;
		}
		100% { 
			background-position: 100% 100%;
		}
	}

	@keyframes nebulaPulse {
		0% {
			opacity: 0.5;
			transform: scale(1);
		}
		100% {
			opacity: 1;
			transform: scale(1.1);
		}
	}

	.category-filter-info {
		display: flex;
		align-items: center;
		justify-content: space-between;
		margin-bottom: 2rem;
		padding: 1rem 1.5rem;
		background: rgba(26, 26, 46, 0.8);
		border: 3px solid #00ff41;
		box-shadow: 4px 4px 0 0 #00ff41;
		position: relative;
		z-index: 1;
	}

	.filter-title {
		font-family: 'Pretendard', 'Courier New', monospace;
		font-size: 1.5rem;
		font-weight: 700;
		color: #00ff41;
		margin: 0;
		text-shadow: 2px 2px 0 #16213e;
		letter-spacing: 0.1em;
	}

	.clear-filter {
		padding: 0.5rem 1rem;
		background: rgba(0, 255, 65, 0.1);
		border: 2px solid #00ff41;
		color: #00ff41;
		text-decoration: none;
		font-family: 'Pretendard', 'Courier New', monospace;
		font-weight: 700;
		font-size: 0.9rem;
		transition: all 0.2s ease;
		box-shadow: 2px 2px 0 0 #00ff41;
	}

	.clear-filter:hover {
		background: rgba(0, 255, 65, 0.2);
		transform: translate(-1px, -1px);
		box-shadow: 3px 3px 0 0 #00ff41;
		color: #ffd700;
		border-color: #ffd700;
	}

	.blog-title {
		font-family: 'Courier New', monospace;
		font-size: clamp(2.5rem, 5vw, 4rem);
		font-weight: 700;
		color: #00ff41;
		text-align: center;
		margin: 0 0 3rem 0;
		text-shadow: 
			4px 4px 0 #16213e,
			8px 8px 0 #1a1a2e;
		letter-spacing: 0.1em;
		position: relative;
		z-index: 1;
	}

	.blog-list {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
		gap: 2rem;
		list-style-type: none;
		margin: 0;
		padding: 0;
		max-width: 1400px;
		margin: 0 auto;
		position: relative;
		z-index: 1;
	}

	.blog-card {
		width: 100%;
	}

	.blog-link {
		display: block;
		text-decoration: none;
		background: rgba(26, 26, 46, 0.8);
		border: 3px solid #00ff41;
		padding: 0;
		transition: all 0.2s ease;
		box-shadow: 4px 4px 0 0 #00ff41;
		overflow: hidden;
	}

	.blog-link:hover {
		transform: translate(-2px, -2px);
		box-shadow: 6px 6px 0 0 #00ff41;
		border-color: #ffd700;
	}

	.blog-image-wrapper {
		width: 100%;
		overflow: hidden;
		background: #0f3460;
	}

	.blog-image {
		width: 100%;
		height: auto;
		display: block;
		transition: transform 0.3s ease;
		image-rendering: pixelated;
	}

	.blog-link:hover .blog-image {
		transform: scale(1.05);
	}

	.blog-content {
		padding: 1.5rem;
	}

	.blog-title-text {
		font-family: 'Courier New', monospace;
		font-size: clamp(1.2rem, 2vw, 1.5rem);
		font-weight: 700;
		margin: 0 0 0.75rem 0;
		color: #00ff41;
		line-height: 1.3;
		text-shadow: 2px 2px 0 #16213e;
		transition: color 0.2s ease;
	}

	.blog-link:hover .blog-title-text {
		color: #ffd700;
	}

	.blog-date {
		font-family: 'Courier New', monospace;
		font-size: 0.9rem;
		margin: 0;
		color: #ffd700;
		text-shadow: 1px 1px 0 #16213e;
	}

	.back-button {
		position: fixed;
		bottom: 2rem;
		right: 2rem;
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 1rem 1.5rem;
		background: rgba(0, 255, 65, 0.1);
		border: 3px solid #00ff41;
		color: #00ff41;
		text-decoration: none;
		font-family: 'Courier New', monospace;
		font-weight: 700;
		font-size: 1.2rem;
		z-index: 1000;
		transition: all 0.2s ease;
		box-shadow: 4px 4px 0 0 #00ff41;
	}

	.back-button:hover {
		background: rgba(0, 255, 65, 0.2);
		transform: translate(-2px, -2px);
		box-shadow: 6px 6px 0 0 #00ff41;
	}

	.back-button:active {
		transform: translate(2px, 2px);
		box-shadow: 2px 2px 0 0 #00ff41;
	}

	.back-arrow {
		font-size: 1.5rem;
		line-height: 1;
	}

	.back-text {
		text-shadow: 2px 2px 0 #16213e;
	}

	@media (max-width: 1279px) {
		.blog-content-wrapper {
			grid-template-columns: 1fr;
			padding: 1rem;
			gap: 1rem;
		}

		.category-sidebar-wrapper {
			position: static;
			top: auto;
			max-height: none;
			order: 2;
		}

		.category-sidebar-wrapper :global(.category-sidebar) {
			max-height: none;
		}

		.tag-cloud-wrapper {
			position: static;
			top: auto;
			max-height: none;
			order: 3;
		}

		.tag-cloud-wrapper :global(.tag-cloud) {
			max-height: none;
		}

		.blog-section {
			order: 1;
		}
	}

	@media (max-width: 768px) {
		.blog-content-wrapper {
			padding: 1rem;
		}

		.blog-list {
			grid-template-columns: 1fr;
			gap: 1.5rem;
		}

		.blog-title {
			margin-bottom: 2rem;
			font-size: clamp(2rem, 6vw, 3rem);
		}

		.back-button {
			bottom: 1rem;
			right: 1rem;
			padding: 0.75rem 1rem;
			font-size: 1rem;
		}
	}
</style>

<script>
	// Clear Filter 버튼 클라이언트 사이드 처리
	document.addEventListener('DOMContentLoaded', () => {
		const clearFilterLink = document.querySelector('.clear-filter');
		const blogCards = document.querySelectorAll('.blog-card');
		const categoryFilterInfo = document.querySelector('.category-filter-info');
		const filterTitle = document.querySelector('.filter-title');
		const categoryLinks = document.querySelectorAll('.category-item a');
		const tagLinks = document.querySelectorAll('.tag-cloud-item');
		
		function clearAllFilters() {
			// URL 업데이트
			window.history.pushState({}, '', '/blog');
			
			// 모든 글 목록 표시
			blogCards.forEach((card) => {
				(card as HTMLElement).style.display = '';
			});
			
			// 필터 정보 숨김
			if (categoryFilterInfo) {
				(categoryFilterInfo as HTMLElement).style.display = 'none';
			}
			if (filterTitle) {
				filterTitle.textContent = '';
			}
			
			// 카테고리 active 상태 제거
			categoryLinks.forEach((link) => {
				link.classList.remove('active');
			});
			
			// 태그 active 상태 제거 (전체만 active)
			tagLinks.forEach((link) => {
				if (link.classList.contains('all-tag')) {
					link.classList.add('active');
				} else {
					link.classList.remove('active');
				}
			});
			
			// 다른 컴포넌트에 알림
			window.dispatchEvent(new CustomEvent('clearAllFilters'));
		}
		
		if (clearFilterLink) {
			clearFilterLink.addEventListener('click', (e) => {
				e.preventDefault();
				clearAllFilters();
			});
		}
		
		// 다른 컴포넌트에서 clearAllFilters 이벤트 수신
		window.addEventListener('clearAllFilters', clearAllFilters);
	});
</script>